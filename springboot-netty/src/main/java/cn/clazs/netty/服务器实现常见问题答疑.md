# Netty æœåŠ¡å™¨å®ç°å¸¸è§é—®é¢˜è§£ç­”

> åŸºäº Netty TCP/HTTP/WebSocket æœåŠ¡å™¨å®ç°çš„ä»£ç å±‚é¢æ·±åº¦è§£æ

---

## ğŸ“š ç›®å½•

- [ä¸€ã€Channel ç±»å‹é€‰æ‹©ï¼šSocketChannel vs NioSocketChannel](#ä¸€channel-ç±»å‹é€‰æ‹©socketchannel-vs-niosocketchannel)
- [äºŒã€option() å’Œ childOption() å‚æ•°è¯¦è§£](#äºŒoption-å’Œ-childoption-å‚æ•°è¯¦è§£)
- [ä¸‰ã€ä¸ºä»€ä¹ˆ TCP æœåŠ¡å™¨ä¸éœ€è¦ç¼–è§£ç å™¨ï¼Ÿ](#ä¸‰ä¸ºä»€ä¹ˆ-tcp-æœåŠ¡å™¨ä¸éœ€è¦ç¼–è§£ç å™¨)
- [å››ã€HTTP æœåŠ¡å™¨ä¸ºä»€ä¹ˆéœ€è¦ç¼–è§£ç å™¨ï¼Ÿ](#å››http-æœåŠ¡å™¨ä¸ºä»€ä¹ˆéœ€è¦ç¼–è§£ç å™¨)
- [äº”ã€HttpObjectAggregator çš„ä½œç”¨](#äº”httpobjectaggregator-çš„ä½œç”¨)
- [å…­ã€æ³›å‹ä¼˜åŒ–ï¼šHttpObject vs FullHttpRequest](#å…­æ³›å‹ä¼˜åŒ–httpobject-vs-fullhttprequest)
- [ä¸ƒã€SimpleChannelInboundHandler vs ChannelInboundHandlerAdapter](#ä¸ƒsimplechannelinboundhandler-vs-channelinboundhandleradapter)
- [å…«ã€ä¸ºä»€ä¹ˆå…¥ç«™å¤„ç†å™¨ç”¨å¾—å¤šï¼Ÿå‡ºç«™å¤„ç†å™¨ä½•æ—¶ç”¨ï¼Ÿ](#å…«ä¸ºä»€ä¹ˆå…¥ç«™å¤„ç†å™¨ç”¨å¾—å¤šå‡ºç«™å¤„ç†å™¨ä½•æ—¶ç”¨)
- [ä¹ã€WebSocket æœåŠ¡å™¨å®ç°è¯¦è§£](#ä¹websocket-æœåŠ¡å™¨å®ç°è¯¦è§£)
- [åã€æ€»ç»“ä¸å…¶ä»–](#åæ€»ç»“ä¸å…¶ä»–)

---

## ä¸€ã€Channel ç±»å‹é€‰æ‹©ï¼šSocketChannel å’Œ NioSocketChannel

### 1.1 ä»£ç ç¤ºä¾‹

```java
// TcpServer.java ç¬¬55è¡Œ
.childHandler(new ChannelInitializer<SocketChannel>() {  // âœ… ä½¿ç”¨æ¥å£
    @Override
    protected void initChannel(SocketChannel ch) {       // âœ… æ¥å£ç±»å‹
        ch.pipeline().addLast(new TcpServerHandler());
    }
})
```

### 1.2 ä¸ºä»€ä¹ˆç”¨ SocketChannel è€Œä¸æ˜¯ NioSocketChannelï¼Ÿ

| ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| **SocketChannel** | **æ¥å£** | âœ… æ¨èï¼é¢å‘æŠ½è±¡ç¼–ç¨‹ |
| **NioSocketChannel** | **å®ç°ç±»** | âš ï¸ ä¸æ¨èï¼ç»‘å®šå…·ä½“å®ç° |

**æ ¸å¿ƒåŸå› ï¼šé¢å‘æ¥å£ç¼–ç¨‹**

```java
// æ¨èï¼šé¢å‘æ¥å£ç¼–ç¨‹
List<String> list = new ArrayList<>();        // âœ…
Map<String, String> map = new HashMap<>();    // âœ…
SocketChannel ch = new NioSocketChannel();    // âœ…

// ä¸æ¨èï¼šé¢å‘å®ç°ç±»ç¼–ç¨‹
ArrayList<String> list = new ArrayList<>();   // âš ï¸
HashMap<String, String> map = new HashMap<>(); // âš ï¸
NioSocketChannel ch = new NioSocketChannel(); // âš ï¸
```

### 1.3 å®é™…è¿è¡Œæ—¶ç±»å‹

```
é…ç½®: .channel(NioServerSocketChannel.class)  // æœåŠ¡å™¨ Channel ç±»å‹
  â†“
æ¥å—å®¢æˆ·ç«¯è¿æ¥
  â†“
è‡ªåŠ¨åˆ›å»º: NioSocketChannel (å®¢æˆ·ç«¯è¿æ¥ Channel)
  â†“
ä¼ é€’ç»™: initChannel(SocketChannel ch)
  â†“
å‚æ•°ç±»å‹: SocketChannel (æ¥å£)
å®é™…å¯¹è±¡: NioSocketChannel (å®ç°ç±») âœ…
```

**ç»“è®º**ï¼šè™½ç„¶å†™çš„æ˜¯ `SocketChannel` æ¥å£ï¼Œä½†è¿è¡Œæ—¶å®é™…å¯¹è±¡æ˜¯ `NioSocketChannel` å®ä¾‹ã€‚

---

## äºŒã€option() å’Œ childOption() å‚æ•°è¯¦è§£

### 2.1 æ ¸å¿ƒåŒºåˆ«

```java
ServerBootstrap bootstrap = new ServerBootstrap();
bootstrap.option(ChannelOption.SO_BACKLOG, 128)           // option()
        .childOption(ChannelOption.SO_KEEPALIVE, true);  // childOption()
```

```mermaid
graph LR
    A[ServerBootstrap] --> B[option<br/>è®¾ç½®æœåŠ¡å™¨Socketå‚æ•°]
    A --> C[childOption<br/>è®¾ç½®å®¢æˆ·ç«¯è¿æ¥Socketå‚æ•°]

    B --> D[å½±å“: ServerSocketChannel<br/>æœåŠ¡å™¨æœ¬èº«çš„Socket]
    C --> E[å½±å“: æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥<br/>SocketChannel]

    style B fill:#f96,stroke:#333,stroke-width:3px
    style C fill:#99f,stroke:#333,stroke-width:3px
    style D fill:#fc9,stroke:#333,stroke-width:2px
    style E fill:#9cf,stroke:#333,stroke-width:2px
```

### 2.2 option() - æœåŠ¡å™¨ Socket å‚æ•°

```java
.option(ChannelOption.SO_BACKLOG, 128)
```

**ä½œç”¨å¯¹è±¡**: `ServerSocketChannel`ï¼ˆæœåŠ¡å™¨æœ¬èº«çš„ Socketï¼‰

**SO_BACKLOG å‚æ•°**:

```
å®¢æˆ·ç«¯1 â”€â”€â”
å®¢æˆ·ç«¯2 â”€â”€â”¼â”€â”€â†’ [è¿æ¥é˜Ÿåˆ— - SO_BACKLOG = 128] â”€â”€â†’ æœåŠ¡å™¨ accept()
å®¢æˆ·ç«¯3 â”€â”€â”¤       â†‘
å®¢æˆ·ç«¯4 â”€â”€â”˜       å½“å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚åˆ°è¾¾ï¼Œä½†æœåŠ¡å™¨è¿˜æ²¡æ¥å¾—åŠ accept æ—¶
                 è¿æ¥ä¼šåœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­ç­‰å¾…
```

**å«ä¹‰**:
- è¿æ¥é˜Ÿåˆ—å¤§å°ï¼ˆ_SYN é˜Ÿåˆ— + ACCEPT é˜Ÿåˆ—ï¼‰
- å½“å®¢æˆ·ç«¯è¿æ¥åˆ°è¾¾ï¼Œä½†æœåŠ¡å™¨è¿˜æ²¡æ¥å¾—åŠ `accept()` æ—¶ï¼Œè¿æ¥åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…
- `128` è¡¨ç¤ºæœ€å¤šå¯ä»¥ç§¯å‹ **128 ä¸ªè¿æ¥è¯·æ±‚**

**ä¸è®¾ç½®çš„åæœ**: ä½¿ç”¨ OS é»˜è®¤å€¼ï¼ˆLinux é€šå¸¸ä¸º 128ï¼‰

**æ¨èå€¼**:
- ä¸­å°å‹åº”ç”¨: `128`
- é«˜å¹¶å‘åœºæ™¯: `1024`
- è¶…é«˜å¹¶å‘ï¼ˆç½‘å…³ï¼‰: `4096`

### 2.3 childOption() - å®¢æˆ·ç«¯è¿æ¥ Socket å‚æ•°

```java
.childOption(ChannelOption.SO_KEEPALIVE, true)
```

**ä½œç”¨å¯¹è±¡**: æ¯ä¸ª `SocketChannel`ï¼ˆæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼‰

**SO_KEEPALIVE å‚æ•°**:
- TCP ä¿æ´»æœºåˆ¶
- å®šæœŸå‘é€æ¢æµ‹åŒ…ï¼Œæ£€æµ‹è¿æ¥æ˜¯å¦è¿˜æ´»ç€
- å¦‚æœå¯¹æ–¹å®•æœº/æ–­ç½‘ï¼Œè‡ªåŠ¨å…³é—­è¿æ¥

**ä¸è®¾ç½®çš„åæœ**: âš ï¸ **å¯èƒ½äº§ç”Ÿåƒµå°¸è¿æ¥ï¼**

| åœºæ™¯ | ä¸è®¾ç½® SO_KEEPALIVE | è®¾ç½® SO_KEEPALIVE |
|------|---------------------|-------------------|
| å®¢æˆ·ç«¯æ­£å¸¸å…³é—­ | âœ… æœåŠ¡å™¨èƒ½æ£€æµ‹åˆ° | âœ… æœåŠ¡å™¨èƒ½æ£€æµ‹åˆ° |
| å®¢æˆ·ç«¯æ–­ç”µ/æ–­ç½‘ | âŒ æœåŠ¡å™¨ä¸çŸ¥é“ï¼Œäº§ç”Ÿåƒµå°¸è¿æ¥ | âœ… 2å°æ—¶åè‡ªåŠ¨æ£€æµ‹å¹¶å…³é—­ |

### 2.4 å¸¸ç”¨å‚æ•°å¯¹æ¯”

| å‚æ•° | æ–¹æ³• | ä½œç”¨å¯¹è±¡ | å«ä¹‰ | æ¨èå€¼ | ä¸è®¾ç½®çš„åæœ |
|------|------|----------|------|--------|--------------|
| **SO_BACKLOG** | `option()` | æœåŠ¡å™¨Socket | è¿æ¥é˜Ÿåˆ—å¤§å° | `128` - `1024` | ä½¿ç”¨OSé»˜è®¤å€¼ |
| **SO_KEEPALIVE** | `childOption()` | å®¢æˆ·ç«¯è¿æ¥ | TCPä¿æ´»æ£€æµ‹ | `true` | âŒ åƒµå°¸è¿æ¥ |
| **SO_REUSEADDR** | `option()` | æœåŠ¡å™¨Socket | ç«¯å£å¤ç”¨ | `true` | é‡å¯æ—¶å¯èƒ½ç«¯å£å ç”¨ |
| **TCP_NODELAY** | `childOption()` | å®¢æˆ·ç«¯è¿æ¥ | ç¦ç”¨Nagleç®—æ³• | `true` | å°æ•°æ®åŒ…å»¶è¿Ÿå‘é€ |

---

## ä¸‰ã€ä¸ºä»€ä¹ˆ TCP æœåŠ¡å™¨ä¸éœ€è¦ç¼–è§£ç å™¨ï¼Ÿ

### 3.1 TCP æœåŠ¡å™¨çš„ Pipeline

```java
// TcpServer.java ç¬¬58è¡Œ
protected void initChannel(SocketChannel ch) {
    ch.pipeline().addLast(new TcpServerHandler());  // ğŸ‘ˆ åªæœ‰ä¸€ä¸ªHandlerï¼
}
```

**Pipeline ç»“æ„**:
```
Head â”€â”€â–¶ TcpServerHandler â”€â”€â–¶ Tail
         (Inbound)
```

### 3.2 åŸå› ï¼šTCP æœ¬èº«å°±æ˜¯å­—èŠ‚æµåè®®

```mermaid
graph LR
    A[å®¢æˆ·ç«¯å‘é€: Hello] --> B[TCP ä¼ è¾“<br/>å­—èŠ‚æµ]
    B --> C[æœåŠ¡å™¨æ¥æ”¶: ByteBuf<br/>åŒ…å« Hello çš„å­—èŠ‚æ•°ç»„]

    style A fill:#9f9,stroke:#333,stroke-width:2px
    style B fill:#fc9,stroke:#333,stroke-width:2px
    style C fill:#9cf,stroke:#333,stroke-width:2px
```

**æ•°æ®æµ**:
```
å®¢æˆ·ç«¯å‘é€: "Hello"
    â†“
TCP ä¼ è¾“ï¼ˆå­—èŠ‚æµï¼‰
    â†“
æœåŠ¡å™¨æ¥æ”¶: ByteBuf (åŒ…å« "Hello" çš„å­—èŠ‚æ•°ç»„)
    â†“
TcpServerHandler.channelRead()
    â†“
ByteBuf buf = (ByteBuf) msg  // ğŸ‘ˆ ç›´æ¥å°±æ˜¯ ByteBufï¼Œæ— éœ€è§£ç ï¼
```

**ä¸ºä»€ä¹ˆç›´æ¥å°±æ˜¯ ByteBufï¼Ÿ**
- TCP æœ¬èº«å°±æ˜¯**å­—èŠ‚æµåè®®**
- Netty æ”¶åˆ° TCP æ•°æ®åï¼Œç›´æ¥å°è£…æˆ `ByteBuf`
- ä¸éœ€è¦ä»»ä½•"è§£ç "è¿‡ç¨‹

### 3.3 ä»£ç ç¤ºä¾‹

```java
// TcpServerHandler.java ç¬¬24è¡Œ
@Override
public void channelRead(ChannelHandlerContext ctx, Object msg) {
    ByteBuf buf = (ByteBuf) msg;  // âœ… ç›´æ¥å¼ºè½¬ï¼Œæ— éœ€è§£ç å™¨
    try {
        String message = buf.toString(StandardCharsets.UTF_8);
        log.info("TCPæœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯: {}", message);

        // Echo æœåŠ¡ï¼šåŸæ ·è¿”å›
        ctx.write(buf);
    } finally {
        buf.release();  // é‡Šæ”¾ç¼“å†²åŒº
    }
}
```

---

## å››ã€HTTP æœåŠ¡å™¨ä¸ºä»€ä¹ˆéœ€è¦ç¼–è§£ç å™¨ï¼Ÿ

### 4.1 HTTP æœåŠ¡å™¨çš„ Pipeline

```java
// HttpServer.java ç¬¬76-82è¡Œ
ChannelPipeline pipeline = ch.pipeline();

// HTTPç¼–è§£ç å™¨
pipeline.addLast(new HttpServerCodec());

// HTTPæ¶ˆæ¯èšåˆå™¨
pipeline.addLast(new HttpObjectAggregator(65536));

// è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨
pipeline.addLast(new HttpServerHandler());
```

**Pipeline ç»“æ„**:
```
Head â”€â”€â–¶ HttpServerCodec â”€â”€â–¶ HttpObjectAggregator â”€â”€â–¶ HttpServerHandler â”€â”€â–¶ Tail
         (Inbound/Outbound)      (Inbound)                (Inbound)
```

### 4.2 åŸå› ï¼šHTTP æ˜¯åº”ç”¨å±‚æ–‡æœ¬åè®®

```mermaid
graph TB
    A[HTTP è¯·æ±‚<br/>æ–‡æœ¬æ ¼å¼] --> B[HTTPç¼–è§£ç å™¨<br/>è§£æè¯·æ±‚è¡Œ/å¤´/ä½“]
    B --> C[FullHttpRequest<br/>ç»“æ„åŒ–å¯¹è±¡]
    C --> D[ä¸šåŠ¡å¤„ç†]

    style A fill:#9f9,stroke:#333,stroke-width:2px
    style B fill:#99f,stroke:#333,stroke-width:3px
    style C fill:#9cf,stroke:#333,stroke-width:2px
    style D fill:#fc9,stroke:#333,stroke-width:2px
```

**HTTP è¯·æ±‚æ ¼å¼**:
```
GET /index.html HTTP/1.1\r\n        â† è¯·æ±‚è¡Œ
Host: localhost:9003\r\n             â† è¯·æ±‚å¤´
Connection: keep-alive\r\n
\r\n                                 â† ç©ºè¡Œ
                                     â† è¯·æ±‚ä½“ï¼ˆå¯é€‰ï¼‰
```

**éœ€è¦è§£æ**:
- è¯·æ±‚è¡Œï¼šæ–¹æ³•ã€URIã€HTTPç‰ˆæœ¬
- è¯·æ±‚å¤´ï¼šé”®å€¼å¯¹
- è¯·æ±‚ä½“ï¼šæ•°æ®

### 4.3 æ•°æ®æµå¯¹æ¯”

#### TCP æœåŠ¡å™¨ï¼ˆä¸éœ€è¦ç¼–è§£ç å™¨ï¼‰

```
å®¢æˆ·ç«¯: "Hello" (å­—ç¬¦ä¸²)
    â†“
TCP å­—èŠ‚æµ
    â†“
æœåŠ¡å™¨: ByteBuf (ç›´æ¥æ¥æ”¶) âœ…
```

#### HTTP æœåŠ¡å™¨ï¼ˆéœ€è¦ç¼–è§£ç å™¨ï¼‰

```
å®¢æˆ·ç«¯: "GET / HTTP/1.1\r\n..." (HTTP æ–‡æœ¬)
    â†“
TCP å­—èŠ‚æµ
    â†“
HttpServerCodec: è§£ç  HTTP æ–‡æœ¬
    â†“
HttpRequest å¯¹è±¡ (ç»“æ„åŒ–æ•°æ®) âœ…
    â†“
HttpObjectAggregator: èšåˆå®Œæ•´è¯·æ±‚
    â†“
FullHttpRequest å¯¹è±¡ (å®Œæ•´è¯·æ±‚) âœ…
```

---

## äº”ã€HttpObjectAggregator çš„ä½œç”¨

### 5.1 ä¸ºä»€ä¹ˆéœ€è¦èšåˆï¼Ÿ

**HTTP è¯·æ±‚å¯èƒ½åˆ†å¤šæ¬¡åˆ°è¾¾**:

```
ç¬¬ä¸€æ¬¡åˆ°è¾¾: HttpRequest (è¯·æ±‚è¡Œ + è¯·æ±‚å¤´)
    â†“
ç¬¬äºŒæ¬¡åˆ°è¾¾: HttpContent (è¯·æ±‚ä½“åˆ†å—1)
    â†“
ç¬¬ä¸‰æ¬¡åˆ°è¾¾: HttpContent (è¯·æ±‚ä½“åˆ†å—2)
    â†“
ç¬¬å››æ¬¡åˆ°è¾¾: LastHttpContent (ç»“æŸæ ‡è®°)
```

### 5.2 èšåˆå‰åå¯¹æ¯”

#### æ²¡æœ‰èšåˆå™¨ï¼ˆä¸æ¨èï¼‰

```java
protected void initChannel(SocketChannel ch) {
    ch.pipeline().addLast(new HttpServerCodec());
    // æ²¡æœ‰ HttpObjectAggregator
    ch.pipeline().addLast(new HttpServerHandler());
}

// Handler éœ€è¦è‡ªå·±å¤„ç†å¤šä¸ªéƒ¨åˆ†
@Override
public void channelRead(ChannelHandlerContext ctx, Object msg) {
    if (msg instanceof HttpRequest) {
        // ç¬¬ä¸€æ¬¡ï¼šåªæœ‰è¯·æ±‚å¤´
        HttpRequest req = (HttpRequest) msg;
        System.out.println("URI: " + req.uri());
    } else if (msg instanceof HttpContent) {
        // åç»­ï¼šè¯·æ±‚ä½“åˆ†å¤šæ¬¡åˆ°è¾¾
        HttpContent content = (HttpContent) msg;
        ByteBuf buf = content.content();
        // æ‰‹åŠ¨æ‹¼æ¥...
    }
}
```

#### æœ‰èšåˆå™¨ï¼ˆæ¨èï¼‰

```java
protected void initChannel(SocketChannel ch) {
    ch.pipeline().addLast(new HttpServerCodec());
    ch.pipeline().addLast(new HttpObjectAggregator(65536));  // èšåˆ
    ch.pipeline().addLast(new HttpServerHandler());
}

// Handler ä¸€æ¬¡æ€§æ”¶åˆ°å®Œæ•´è¯·æ±‚
@Override
protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest req) {
    // âœ… ä¸€æ¬¡æ€§æ”¶åˆ°å®Œæ•´çš„ HTTP è¯·æ±‚
    String uri = req.uri();
    String body = req.content().toString(StandardCharsets.UTF_8);
}
```

### 5.3 èšåˆå™¨å‚æ•°

```java
new HttpObjectAggregator(65536)  // 65536 = 64KB
```

**å«ä¹‰**: æœ€å¤§å†…å®¹é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰

- å¦‚æœ HTTP è¯·æ±‚ä½“è¶…è¿‡ 64KBï¼Œä¼šè¿”å› `413 Request Entity Too Large`
- æ¨èå€¼ï¼š
  - å°å‹åº”ç”¨: `65536` (64KB)
  - ä¸­å‹åº”ç”¨: `1048576` (1MB)
  - å¤§æ–‡ä»¶ä¸Šä¼ : `10485760` (10MB) æˆ–æ›´å¤§

---

## å…­ã€æ³›å‹ä¼˜åŒ–ï¼šHttpObject ä¸ FullHttpRequest

### 6.1 ä¼˜åŒ–å‰

```java
public class HttpServerHandler extends SimpleChannelInboundHandler<HttpObject> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, HttpObject msg) {
        if (msg instanceof HttpRequest) {  // âŒ å¤šä½™çš„åˆ¤æ–­
            HttpRequest req = (HttpRequest) msg;
            String uri = req.uri();
            // ...
        }
    }
}
```

**é—®é¢˜**:
- æ³›å‹ `HttpObject` å¤ªæ¨¡ç³Š
- `instanceof HttpRequest` åˆ¤æ–­æ˜¯å¤šä½™çš„ï¼ˆ`FullHttpRequest` æœ¬èº«å°±æ˜¯ `HttpRequest` çš„å­æ¥å£ï¼‰

### 6.2 ä¼˜åŒ–å

```java
public class HttpServerHandler extends SimpleChannelInboundHandler<FullHttpRequest> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest req) {
        // âœ… ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ç±»å‹åˆ¤æ–­
        String uri = req.uri();
        String method = req.method().name();
        // ...
    }
}
```

**æ”¹è¿›**:
1. âœ… æ³›å‹æ›´ç²¾ç¡®ï¼š`FullHttpRequest` è€Œä¸æ˜¯ `HttpObject`
2. âœ… åˆ é™¤å¤šä½™çš„ `instanceof` åˆ¤æ–­
3. âœ… åˆ é™¤ç±»å‹å¼ºè½¬
4. âœ… ä»£ç æ›´ç®€æ´ï¼Œç±»å‹æ›´å®‰å…¨

### 6.3 ç±»å‹å±‚æ¬¡å…³ç³»

```
HttpObject (é¡¶å±‚æ¥å£)
    â”‚
    â”œâ”€â”€ HttpRequest (è¯·æ±‚æ¥å£)
    â”‚     â”‚
    â”‚     â””â”€â”€ FullHttpRequest (å®Œæ•´è¯·æ±‚) âœ… èšåˆåçš„ç±»å‹
    â”‚
    â”œâ”€â”€ HttpContent (å†…å®¹æ¥å£)
    â”‚
    â””â”€â”€ HttpResponse (å“åº”æ¥å£)
```

---

## ä¸ƒã€SimpleChannelInboundHandler ä¸ ChannelInboundHandlerAdapter

### 7.1 ä¸¤ä¸ªæ ¸å¿ƒå…¥ç«™å¤„ç†å™¨å¯¹æ¯”

Netty æä¾›äº†ä¸¤ä¸ªå¸¸ç”¨çš„å…¥ç«™å¤„ç†å™¨é€‚é…å™¨ï¼š

| ç‰¹æ€§ | ChannelInboundHandlerAdapter | SimpleChannelInboundHandler\<T\> |
|------|----------------------------|---------------------------|
| **ç±»å‹** | é€‚é…å™¨ç±»ï¼ˆAdapterï¼‰ | ç®€åŒ–å¤„ç†å™¨ï¼ˆSimpleï¼‰ |
| **æ³›å‹æ”¯æŒ** | âŒ ä¸æ”¯æŒæ³›å‹ | âœ… æ”¯æŒæ³›å‹ï¼ˆæŒ‡å®šæ¶ˆæ¯ç±»å‹ï¼‰ |
| **ç±»å‹è½¬æ¢** | âŒ éœ€è¦æ‰‹åŠ¨å¼ºè½¬ | âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢ |
| **èµ„æºé‡Šæ”¾** | âŒ éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ | âœ… **è‡ªåŠ¨é‡Šæ”¾èµ„æº** |
| **è¿‡æ»¤æ¶ˆæ¯** | âŒ ä¸è‡ªåŠ¨è¿‡æ»¤ | âœ… **åªå¤„ç†æŒ‡å®šç±»å‹** |
| **ä½¿ç”¨åœºæ™¯** | éœ€è¦åº•å±‚æ§åˆ¶ | **å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯** âœ… |
| **æ¨èç¨‹åº¦** | âš ï¸ ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ | âœ… **æ¨èä½¿ç”¨** |

### 7.2 ChannelInboundHandlerAdapter

#### ä»£ç ç¤ºä¾‹

```java
// TcpServerHandler.java ç¬¬18è¡Œ
public class TcpServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        ByteBuf buf = (ByteBuf) msg;  // âŒ æ‰‹åŠ¨å¼ºè½¬
        try {
            String message = buf.toString(StandardCharsets.UTF_8);
            log.info("æ”¶åˆ°æ¶ˆæ¯: {}", message);

            ctx.write(buf);  // å†™å…¥ç¼“å†²åŒº
        } finally {
            buf.release();  // âŒ æ‰‹åŠ¨é‡Šæ”¾èµ„æº
        }
    }
}
```

#### ç‰¹ç‚¹

**ä¼˜ç‚¹**:
- âœ… æ›´çµæ´»ï¼Œå¯ä»¥å¤„ç†ä»»æ„ç±»å‹çš„æ¶ˆæ¯
- âœ… å¯ä»¥é€‰æ‹©æ€§å¤„ç†æŸäº›æ¶ˆæ¯ï¼ˆé€šè¿‡ `instanceof` åˆ¤æ–­ï¼‰
- âœ… æ›´åº•å±‚ï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶èµ„æºé‡Šæ”¾æ—¶æœº

**ç¼ºç‚¹**:
- âŒ éœ€è¦æ‰‹åŠ¨ç±»å‹å¼ºè½¬ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰
- âŒ **éœ€è¦æ‰‹åŠ¨é‡Šæ”¾èµ„æº**ï¼ˆå®¹æ˜“å†…å­˜æ³„æ¼ï¼ï¼‰
- âŒ ä»£ç æ›´å†—é•¿

**é€‚ç”¨åœºæ™¯**:
- éœ€è¦åŒæ—¶å¤„ç†å¤šç§ä¸åŒç±»å‹çš„æ¶ˆæ¯
- éœ€è¦ç²¾ç¡®æ§åˆ¶èµ„æºé‡Šæ”¾æ—¶æœº
- éœ€è¦åœ¨ Pipeline ä¸­ä¼ é€’æ¶ˆæ¯ï¼ˆä¸æ¶ˆè´¹æ¶ˆæ¯ï¼‰

### 7.3 SimpleChannelInboundHandler\<T\>

#### ä»£ç ç¤ºä¾‹

```java
// HttpServerHandler.java ç¬¬43è¡Œï¼ˆä¼˜åŒ–åï¼‰
public class HttpServerHandler extends SimpleChannelInboundHandler<FullHttpRequest> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest req) {
        // âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼Œæ— éœ€å¼ºè½¬
        String uri = req.uri();
        String method = req.method().name();

        // âœ… è‡ªåŠ¨é‡Šæ”¾èµ„æºï¼Œæ— éœ€æ‰‹åŠ¨ release()
        log.info("æ”¶åˆ°è¯·æ±‚: {} {}", method, uri);

        FullHttpResponse response = new DefaultFullHttpResponse(...);
        ctx.writeAndFlush(response);
        // âœ… req ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼ŒåŒ…æ‹¬å…¶å†…éƒ¨çš„ ByteBuf
    }
}
```

#### ç‰¹ç‚¹

**ä¼˜ç‚¹**:
- âœ… **æ³›å‹æ”¯æŒ**ï¼šæŒ‡å®šåªå¤„ç†ç‰¹å®šç±»å‹çš„æ¶ˆæ¯
- âœ… **è‡ªåŠ¨ç±»å‹è½¬æ¢**ï¼šæ— éœ€æ‰‹åŠ¨å¼ºè½¬
- âœ… **è‡ªåŠ¨èµ„æºé‡Šæ”¾**ï¼š**å¤„ç†å®Œæ¶ˆæ¯åè‡ªåŠ¨é‡Šæ”¾ ByteBuf**
- âœ… **ç±»å‹è¿‡æ»¤**ï¼šåªå¤„ç†æŒ‡å®šç±»å‹ï¼Œå…¶ä»–ç±»å‹è‡ªåŠ¨è·³è¿‡
- âœ… **ä»£ç ç®€æ´**ï¼šå‡å°‘æ¨¡æ¿ä»£ç 

**ç¼ºç‚¹**:
- âš ï¸ åªèƒ½å¤„ç†ä¸€ç§ç±»å‹ï¼ˆå¦‚æœéœ€è¦å¤„ç†å¤šç§ï¼Œéœ€è¦å¤šä¸ª Handlerï¼‰
- âš ï¸ ä¼šæ¶ˆè´¹æ¶ˆæ¯ï¼ˆä¼ é€’ç»™ä¸‹ä¸€ä¸ª Handler ä¹‹å‰ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼‰

**é€‚ç”¨åœºæ™¯**:
- âœ… **å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯**ï¼ˆæ¨èï¼‰
- åªéœ€è¦å¤„ç†ç‰¹å®šç±»å‹çš„æ¶ˆæ¯
- å¸Œæœ›è‡ªåŠ¨ç®¡ç†èµ„æºé‡Šæ”¾

### 7.4 æ ¸å¿ƒåŒºåˆ«ï¼šèµ„æºé‡Šæ”¾

#### ChannelInboundHandlerAdapter çš„èµ„æºç®¡ç†

```java
public class TcpServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        ByteBuf buf = (ByteBuf) msg;
        try {
            // ä½¿ç”¨ buf
            String message = buf.toString(StandardCharsets.UTF_8);
            ctx.write(buf);
        } finally {
            buf.release();  // âŒ å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾ï¼Œå¦åˆ™å†…å­˜æ³„æ¼ï¼
        }
    }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Ÿ**

```
ByteBuf å¼•ç”¨è®¡æ•°æœºåˆ¶:
åˆå§‹çŠ¶æ€: refCnt = 1

channelRead() è§¦å‘:
  â†’ ä¼ å…¥ ByteBuf (refCnt = 1)

å¦‚æœä¸é‡Šæ”¾:
  â†’ refCnt ä¸€ç›´ä¸º 1
  â†’ å†…å­˜æ°¸è¿œä¸ä¼šå›æ”¶
  â†’ å†…å­˜æ³„æ¼ï¼ âŒ

å¦‚æœæ‰‹åŠ¨é‡Šæ”¾:
  â†’ buf.release() (refCnt = 0)
  â†’ å†…å­˜å›æ”¶ âœ…
```

#### SimpleChannelInboundHandler\<T\> çš„èµ„æºç®¡ç†

```java
public class HttpServerHandler extends SimpleChannelInboundHandler<FullHttpRequest> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest req) {
        // âœ… ä½¿ç”¨ req
        String uri = req.uri();

        // âœ… ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼æ–¹æ³•ç»“æŸåè‡ªåŠ¨é‡Šæ”¾
    }
}
```

**è‡ªåŠ¨é‡Šæ”¾åŸç†**:

```
SimpleChannelInboundHandler.channelRead() è¢«è°ƒç”¨:
  â†’ è°ƒç”¨ channelRead0(ctx, msg)
  â†’ channelRead0() æ‰§è¡Œå®Œæ¯•
  â†’ è‡ªåŠ¨è°ƒç”¨ ReferenceCountUtil.release(msg) âœ…
  â†’ å†…å­˜å›æ”¶ âœ…
```

### 7.5 ç±»å‹è¿‡æ»¤æœºåˆ¶

#### SimpleChannelInboundHandler çš„ç±»å‹è¿‡æ»¤

```java
public class TextWebSocketFrameHandler extends SimpleChannelInboundHandler<TextWebSocketFrame> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame frame) {
        // âœ… åªå¤„ç† TextWebSocketFrame
        String text = frame.text();
        System.out.println("æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯: " + text);
    }
}
```

**Pipeline æ•°æ®æµ**:

```
å…¥ç«™æ•°æ®æµ:
ByteBuf
  â†’ HttpServerCodec è§£ç 
  â†’ HttpRequest (SimpleChannelInboundHandler<FullHttpRequest> å¤„ç†) âœ…
  â†’ HttpContent (è·³è¿‡ï¼Œå› ä¸ºä¸æ˜¯ FullHttpRequest) âœ…
  â†’ WebSocketFrame
      â†’ BinaryWebSocketFrame (SimpleChannelInboundHandler<TextWebSocketFrame> è·³è¿‡) âœ…
      â†’ TextWebSocketFrame (SimpleChannelInboundHandler<TextWebSocketFrame> å¤„ç†) âœ…
```

**å…³é”®ç‚¹**:
- âœ… åªå¤„ç†æŒ‡å®šç±»å‹çš„æ¶ˆæ¯
- âœ… å…¶ä»–ç±»å‹è‡ªåŠ¨ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Handler
- âœ… å¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ª Handler èƒ½å¤„ç†ï¼Œä¼šè¢«ä¸¢å¼ƒ

### 7.6 ä½•æ—¶ä½¿ç”¨å“ªä¸ªï¼Ÿ

#### ä½¿ç”¨ ChannelInboundHandlerAdapter çš„åœºæ™¯

```java
// åœºæ™¯1: éœ€è¦åŒæ—¶å¤„ç†å¤šç§ç±»å‹
public class MultiTypeHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        if (msg instanceof HttpRequest) {
            // å¤„ç† HTTP è¯·æ±‚
        } else if (msg instanceof HttpContent) {
            // å¤„ç† HTTP å†…å®¹å—
        } else if (msg instanceof WebSocketFrame) {
            // å¤„ç† WebSocket å¸§
        }
        // æ‰‹åŠ¨å†³å®šæ˜¯å¦ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Handler
    }
}

// åœºæ™¯2: éœ€è¦åœ¨ Pipeline ä¸­ä¼ é€’æ¶ˆæ¯ï¼ˆä¸æ¶ˆè´¹ï¼‰
public class LoggingHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        log.info("æ”¶åˆ°æ¶ˆæ¯: {}", msg);
        ctx.fireChannelRead(msg);  // âœ… ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Handlerï¼ˆä¸æ¶ˆè´¹ï¼‰
    }
}
```

#### ä½¿ç”¨ SimpleChannelInboundHandler\<T\> çš„åœºæ™¯ï¼ˆæ¨èï¼‰

```java
// åœºæ™¯1: åªå¤„ç†ä¸€ç§ç±»å‹ï¼ˆæœ€å¸¸è§ï¼‰
public class HttpServerHandler extends SimpleChannelInboundHandler<FullHttpRequest> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest req) {
        // âœ… åªå¤„ç† FullHttpRequest
        // âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢
        // âœ… è‡ªåŠ¨èµ„æºé‡Šæ”¾
    }
}

// åœºæ™¯2: WebSocket æ–‡æœ¬æ¶ˆæ¯å¤„ç†
public class WebSocketHandler extends SimpleChannelInboundHandler<TextWebSocketFrame> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame frame) {
        // âœ… åªå¤„ç†æ–‡æœ¬å¸§
        // âœ… å…¶ä»–å¸§ç±»å‹è‡ªåŠ¨è·³è¿‡
    }
}
```

### 7.7 å®é™…é¡¹ç›®å¯¹æ¯”

#### TCP æœåŠ¡å™¨ï¼ˆä½¿ç”¨ ChannelInboundHandlerAdapterï¼‰

```java
// TcpServerHandler.java
public class TcpServerHandler extends ChannelInboundHandlerAdapter {

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        ByteBuf buf = (ByteBuf) msg;  // âŒ æ‰‹åŠ¨å¼ºè½¬
        try {
            // ... ä¸šåŠ¡é€»è¾‘
        } finally {
            buf.release();  // âŒ æ‰‹åŠ¨é‡Šæ”¾
        }
    }
}
```

**ä¸ºä»€ä¹ˆç”¨ ChannelInboundHandlerAdapterï¼Ÿ**
- TCP æ˜¯å­—èŠ‚æµåè®®ï¼Œéœ€è¦å¤„ç†åŸå§‹ `ByteBuf`
- éœ€è¦æ‰‹åŠ¨æ§åˆ¶èµ„æºé‡Šæ”¾æ—¶æœºï¼ˆwrite åå† releaseï¼‰

#### HTTP æœåŠ¡å™¨ï¼ˆä½¿ç”¨ SimpleChannelInboundHandlerï¼‰

```java
// HttpServerHandler.java
public class HttpServerHandler extends SimpleChannelInboundHandler<FullHttpRequest> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest req) {
        // âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢
        // âœ… è‡ªåŠ¨èµ„æºé‡Šæ”¾
    }
}
```

**ä¸ºä»€ä¹ˆç”¨ SimpleChannelInboundHandlerï¼Ÿ**
- åªå¤„ç† `FullHttpRequest` ç±»å‹
- è‡ªåŠ¨ç®¡ç†èµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼
- ä»£ç æ›´ç®€æ´

### 7.8 æ€»ç»“ï¼šæ¨èä½¿ç”¨

| åœºæ™¯ | æ¨èä½¿ç”¨ | åŸå›  |
|------|----------|------|
| **å¤§éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘** | âœ… **SimpleChannelInboundHandler\<T\>** | è‡ªåŠ¨ç±»å‹è½¬æ¢ã€è‡ªåŠ¨èµ„æºé‡Šæ”¾ |
| **åªå¤„ç†ä¸€ç§æ¶ˆæ¯ç±»å‹** | âœ… **SimpleChannelInboundHandler\<T\>** | ç±»å‹è¿‡æ»¤ã€ä»£ç ç®€æ´ |
| **éœ€è¦å¤„ç†å¤šç§ç±»å‹** | âš ï¸ ChannelInboundHandlerAdapter | çµæ´»æ§åˆ¶ç±»å‹åˆ¤æ–­ |
| **éœ€è¦åœ¨ Pipeline ä¸­ä¼ é€’æ¶ˆæ¯** | âš ï¸ ChannelInboundHandlerAdapter | å¯ä»¥è°ƒç”¨ `fireChannelRead()` |
| **TCP å­—èŠ‚æµå¤„ç†** | âš ï¸ ChannelInboundHandlerAdapter | éœ€è¦ç²¾ç¡®æ§åˆ¶èµ„æºé‡Šæ”¾ |

**æœ€ä½³å®è·µ**: âœ… **ä¼˜å…ˆä½¿ç”¨ SimpleChannelInboundHandler\<T\>**

---

## å…«ã€ä¸ºä»€ä¹ˆå…¥ç«™å¤„ç†å™¨ç”¨å¾—å¤šï¼Ÿå‡ºç«™å¤„ç†å™¨ä½•æ—¶ç”¨ï¼Ÿ

### 8.1 å¤§éƒ¨åˆ†ä¸šåŠ¡ä»£ç éƒ½å†™åœ¨**å…¥ç«™å¤„ç†å™¨**ä¸­

**ç¡®å®å¦‚æ­¤**ï¼šå¤§éƒ¨åˆ† Demo å’Œä¸šåŠ¡ä»£ç éƒ½å†™åœ¨**å…¥ç«™å¤„ç†å™¨**ä¸­ï¼Œå‡ºç«™å¤„ç†å™¨å¾ˆå°‘ç”¨åˆ°ï¼

#### ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

```
å…¸å‹çš„æœåŠ¡å™¨ä¸šåŠ¡æµç¨‹:
1. æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆå…¥ç«™äº‹ä»¶ï¼‰
2. å¤„ç†ä¸šåŠ¡é€»è¾‘
3. è¿”å›å“åº”ï¼ˆåœ¨å…¥ç«™å¤„ç†å™¨ä¸­ writeAndFlushï¼‰
   â†“
æ•´ä¸ªæµç¨‹éƒ½åœ¨å…¥ç«™å¤„ç†å™¨ä¸­å®Œæˆ âœ…
```

### 8.2 å…¥ç«™å¤„ç†å™¨ vs å‡ºç«™å¤„ç†å™¨

#### èŒè´£å¯¹æ¯”

| å¤„ç†å™¨ç±»å‹ | æ–¹å‘ | å¤„ç†çš„äº‹ä»¶ | ç¤ºä¾‹ |
|-----------|------|-----------|------|
| **ChannelInboundHandler** | å…¥ç«™<br/>ï¼ˆå®¢æˆ·ç«¯â†’æœåŠ¡å™¨ï¼‰ | è¯»å–æ•°æ®ã€è¿æ¥å»ºç«‹ã€è¿æ¥æ–­å¼€ | `channelRead()`<br/>`channelActive()`<br/>`channelInactive()` |
| **ChannelOutboundHandler** | å‡ºç«™<br/>ï¼ˆæœåŠ¡å™¨â†’å®¢æˆ·ç«¯ï¼‰ | å†™æ•°æ®ã€è¿æ¥ã€å…³é—­ã€ç»‘å®š | `write()`<br/>`flush()`<br/>`connect()`<br/>`close()` |

#### æ•°æ®æµå‘å›¾

```mermaid
graph TB
    subgraph å…¥ç«™-å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨
    A1[å®¢æˆ·ç«¯å‘é€æ•°æ®] --> A2[channelRead<br/>å…¥ç«™å¤„ç†å™¨]
    A2 --> A3[ä¸šåŠ¡é€»è¾‘å¤„ç†]
    end

    subgraph å‡ºç«™-æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯
    B1[ä¸šåŠ¡é€»è¾‘è°ƒç”¨write] --> B2[write/flush<br/>å‡ºç«™å¤„ç†å™¨]
    B2 --> B3[å‘é€ç»™å®¢æˆ·ç«¯]
    end

    A3 -.å¯ä»¥è°ƒç”¨ write.-> B1

    style A2 fill:#9f9,stroke:#333,stroke-width:2px
    style B2 fill:#99f,stroke:#333,stroke-width:2px
```

### 8.3 ä¸ºä»€ä¹ˆ writeAndFlush å¯ä»¥åœ¨å…¥ç«™å¤„ç†å™¨ä¸­è°ƒç”¨ï¼Ÿ

#### æ ¸å¿ƒåŸç†

**å…¥ç«™å¤„ç†å™¨å¯ä»¥è°ƒç”¨å‡ºç«™æ“ä½œ**ï¼

```java
@Override
public void channelRead(ChannelHandlerContext ctx, Object msg) {
    // è¿™æ˜¯å…¥ç«™å¤„ç†å™¨ï¼ˆå¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®ï¼‰

    // âœ… å¯ä»¥è°ƒç”¨å‡ºç«™æ“ä½œï¼šå†™å…¥æ•°æ®å¹¶å‘é€ç»™å®¢æˆ·ç«¯
    ctx.writeAndFlush(response);

    // åŸç†ï¼š
    // write() ä¼šè§¦å‘ Pipeline ä¸­çš„å‡ºç«™å¤„ç†å™¨
    // æœ€ç»ˆå†™å…¥ Socket å‘é€ç»™å®¢æˆ·ç«¯
}
```

#### å†…éƒ¨æµç¨‹

```
å…¥ç«™å¤„ç†å™¨ä¸­è°ƒç”¨ ctx.writeAndFlush(response):
    â†“
è§¦å‘å‡ºç«™äº‹ä»¶
    â†“
ä» Tail å¼€å§‹åå‘ä¼ æ’­ï¼ˆç»è¿‡æ‰€æœ‰ OutboundHandlerï¼‰
    â†“
ç»è¿‡ HttpServerCodecï¼ˆç¼–ç å™¨ï¼‰:
    FullHttpResponse â†’ ByteBuf
    â†“
åˆ°è¾¾ Head
    â†“
å†™å…¥ Socket
    â†“
å‘é€ç»™å®¢æˆ·ç«¯ âœ…
```

### 8.4 ä»€ä¹ˆæ—¶å€™éœ€è¦ä¸“é—¨çš„å‡ºç«™å¤„ç†å™¨ï¼Ÿ

#### åœºæ™¯1: æ•°æ®ç¼–ç /åºåˆ—åŒ–ï¼ˆæœ€å¸¸è§ï¼‰

```java
// å‡ºç«™å¤„ç†å™¨ï¼šå°†å¯¹è±¡ç¼–ç ä¸ºå­—èŠ‚
@Component
@ChannelHandler.Sharable
public class MessageEncoder extends MessageToByteEncoder<MyMessage> {

    @Override
    protected void encode(ChannelHandlerContext ctx, MyMessage msg, ByteBuf out) {
        // å°† MyMessage å¯¹è±¡ç¼–ç ä¸º ByteBuf
        byte[] data = serialize(msg);
        out.writeBytes(data);
    }
}

// Pipeline é…ç½®
pipeline.addLast(new MessageEncoder());  // å‡ºç«™å¤„ç†å™¨ï¼šç¼–ç 
pipeline.addLast(new MyBusinessHandler()); // å…¥ç«™å¤„ç†å™¨ï¼šä¸šåŠ¡é€»è¾‘
```

**æ•°æ®æµ**:
```
ä¸šåŠ¡ Handler: ctx.write(new MyMessage(...))
    â†“
MessageEncoder.encode(): MyMessage â†’ ByteBuf
    â†“
å‘é€ç»™å®¢æˆ·ç«¯
```

#### åœºæ™¯2: æ•°æ®å‹ç¼©

```java
// å‡ºç«™å¤„ç†å™¨ï¼šå‹ç¼©æ•°æ®
public class CompressionHandler extends ChannelOutboundHandlerAdapter {

    @Override
    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {
        if (msg instanceof ByteBuf) {
            ByteBuf original = (ByteBuf) msg;
            ByteBuf compressed = compress(original);  // å‹ç¼©
            ctx.write(compressed, promise);
        } else {
            ctx.write(msg, promise);
        }
    }
}
```

#### åœºæ™¯3: æ•°æ®åŠ å¯†

```java
// å‡ºç«™å¤„ç†å™¨ï¼šåŠ å¯†æ•°æ®
public class EncryptionHandler extends ChannelOutboundHandlerAdapter {

    @Override
    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {
        if (msg instanceof ByteBuf) {
            ByteBuf original = (ByteBuf) msg;
            ByteBuf encrypted = encrypt(original);  // åŠ å¯†
            ctx.write(encrypted, promise);
        } else {
            ctx.write(msg, promise);
        }
    }
}
```

#### åœºæ™¯4: æ—¥å¿—è®°å½•

```java
// å‡ºç«™å¤„ç†å™¨ï¼šè®°å½•å‘é€çš„æ•°æ®
public class OutboundLoggingHandler extends ChannelOutboundHandlerAdapter {

    @Override
    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {
        log.info("å‘é€æ•°æ®: {}", msg);
        ctx.write(msg, promise);  // ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå‡ºç«™å¤„ç†å™¨
    }
}
```

### 8.5 å®é™…é¡¹ç›®å¯¹æ¯”

#### HTTP æœåŠ¡å™¨ï¼ˆæ— ä¸“é—¨å‡ºç«™å¤„ç†å™¨ï¼‰

```java
// HttpServerHandler.java
public class HttpServerHandler extends SimpleChannelInboundHandler<FullHttpRequest> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest req) {
        // ä¸šåŠ¡é€»è¾‘
        FullHttpResponse response = new DefaultFullHttpResponse(...);

        // âœ… åœ¨å…¥ç«™å¤„ç†å™¨ä¸­ç›´æ¥å†™å›å“åº”
        ctx.writeAndFlush(response);
    }
}
```

**Pipeline**:
```
Head â†’ HttpServerCodec â†’ HttpObjectAggregator â†’ HttpServerHandler â†’ Tail
      (Inbound/Outbound)      (Inbound)                (Inbound)
```

**ä¸ºä»€ä¹ˆä¸éœ€è¦ä¸“é—¨å‡ºç«™å¤„ç†å™¨ï¼Ÿ**
- `HttpServerCodec` å·²ç»åŒ…å«äº†å“åº”ç¼–ç å™¨
- å…¥ç«™å¤„ç†å™¨ç›´æ¥ `writeAndFlush(response)`
- `HttpServerCodec` ä¼šè‡ªåŠ¨å°† `FullHttpResponse` ç¼–ç ä¸º `ByteBuf`

#### è‡ªå®šä¹‰åè®®ï¼ˆéœ€è¦ä¸“é—¨å‡ºç«™å¤„ç†å™¨ï¼‰

```java
// Pipeline é…ç½®
pipeline.addLast(new MessageDecoder());      // å…¥ç«™ï¼šè§£ç 
pipeline.addLast(new MessageEncoder());      // å‡ºç«™ï¼šç¼–ç 
pipeline.addLast(new BusinessHandler());    // å…¥ç«™ï¼šä¸šåŠ¡é€»è¾‘
```

**Pipeline**:
```
Head â†’ MessageDecoder â†’ BusinessHandler â†’ MessageEncoder â†’ Tail
       (Inbound)         (Inbound)           (Outbound)
```

**æ•°æ®æµ**:
```
å…¥ç«™: ByteBuf â†’ MessageDecoder â†’ MyMessage â†’ BusinessHandler
å‡ºç«™: BusinessHandler.write(MyMessage) â†’ MessageEncoder â†’ ByteBuf â†’ å‘é€
```

### 8.6 å‡ºç«™å¤„ç†å™¨çš„ä¼ æ’­æ–¹å‘

```java
// å…¥ç«™å¤„ç†å™¨ä¸­è°ƒç”¨ write
ctx.writeAndFlush(response);
    â†“
è§¦å‘å‡ºç«™äº‹ä»¶ï¼Œä» Tail åå‘ä¼ æ’­åˆ° Head
    â†“
ä¼ æ’­é“¾è·¯:
Tail
  â† BusinessHandler (å¦‚æœæ˜¯ Outbound)
  â† MessageEncoder (Outbound) â† ç¼–ç  MyMessage â†’ ByteBuf
  â† HttpServerCodec (Outbound) â† ç¼–ç  FullHttpResponse â†’ ByteBuf
  â† Head
    â†“
å†™å…¥ Socket
    â†“
å‘é€ç»™å®¢æˆ·ç«¯
```

### 8.7 æ€»ç»“ï¼šä¸ºä»€ä¹ˆå…¥ç«™å¤„ç†å™¨ç”¨å¾—å¤šï¼Ÿ

| æ–¹é¢ | å…¥ç«™å¤„ç†å™¨ | å‡ºç«™å¤„ç†å™¨ |
|------|-----------|-----------|
| **ä½¿ç”¨é¢‘ç‡** | âœ… **éå¸¸é«˜**ï¼ˆå¤§éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ï¼‰ | âš ï¸ è¾ƒå°‘ï¼ˆç¼–è§£ç ã€å‹ç¼©ã€åŠ å¯†ï¼‰ |
| **åŸå› ** | ä¸šåŠ¡é€»è¾‘ä¸»è¦æ˜¯"æ¥æ”¶è¯·æ±‚â†’å¤„ç†â†’è¿”å›å“åº”" | Netty è‡ªå¸¦çš„ Handler å·²ç»è¦†ç›–å¤§éƒ¨åˆ†å‡ºç«™åœºæ™¯ |
| **å…¸å‹æ“ä½œ** | `channelRead()`, `channelActive()` | `write()`, `flush()`, `connect()` |
| **å¯ä»¥è°ƒç”¨** | âœ… å¯ä»¥è°ƒç”¨ `writeAndFlush()` | âŒ ä¸èƒ½ç›´æ¥è°ƒç”¨ `channelRead()` |
| **å…¸å‹åœºæ™¯** | ä¸šåŠ¡é€»è¾‘å¤„ç† | ç¼–ç ã€å‹ç¼©ã€åŠ å¯†ã€æ—¥å¿— |

**å…³é”®ç‚¹**:
1. âœ… **å…¥ç«™å¤„ç†å™¨å¯ä»¥è°ƒç”¨å‡ºç«™æ“ä½œ**ï¼ˆ`ctx.writeAndFlush()`ï¼‰
2. âœ… **å¤§éƒ¨åˆ†åœºæ™¯ä¸éœ€è¦ä¸“é—¨çš„å‡ºç«™å¤„ç†å™¨**
3. âš ï¸ **éœ€è¦è‡ªå®šä¹‰ç¼–ç /å‹ç¼©/åŠ å¯†æ—¶ï¼Œæ‰éœ€è¦ä¸“é—¨å‡ºç«™å¤„ç†å™¨**
4. âœ… **Netty è‡ªå¸¦çš„ç¼–è§£ç å™¨å·²ç»è¶³å¤Ÿ**ï¼ˆå¦‚ `HttpServerCodec`ï¼‰

**æœ€ä½³å®è·µ**:
- ä¸šåŠ¡ä»£ç å†™åœ¨å…¥ç«™å¤„ç†å™¨ä¸­ âœ…
- éœ€è¦è‡ªå®šä¹‰ç¼–ç æ—¶ï¼Œæ·»åŠ ä¸“é—¨çš„å‡ºç«™å¤„ç†å™¨ âš ï¸
- ä¼˜å…ˆä½¿ç”¨ Netty è‡ªå¸¦çš„å‡ºç«™å¤„ç†å™¨ âœ…

---

## ä¹ã€WebSocket æœåŠ¡å™¨å®ç°è¯¦è§£

### 9.1 ä¸ºä»€ä¹ˆéœ€è¦ WebSocketï¼ŸTCP ä¸å¤Ÿå—ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜**ï¼šTCP æœ¬èº«æ”¯æŒå…¨åŒå·¥é€šä¿¡ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨ WebSocketï¼Ÿ

#### TCP å…¨åŒå·¥é€šä¿¡çš„å±€é™

```mermaid
graph TB
    subgraph tcp ["TCP-ä¼ è¾“å±‚-å…¨åŒå·¥"]
    A1[å®¢æˆ·ç«¯] <--> |å­—èŠ‚æµ| A2[æœåŠ¡å™¨]
    A1 -. å‘é€ .-> A2
    A2 -. ä¸»åŠ¨æ¨é€ .-> A1
    end

    subgraph http ["åº”ç”¨å±‚-HTTPçš„é™åˆ¶"]
    B1[å®¢æˆ·ç«¯] --> |è¯·æ±‚| B2[æœåŠ¡å™¨]
    B2 --> |å“åº”| B1
    B2 -. "æ— æ³•ä¸»åŠ¨æ¨é€ âŒ" .-> B1
    end

    style A2 fill:#9f9,stroke:#333,stroke-width:2px
    style B2 fill:#f99,stroke:#333,stroke-width:2px
```

**TCP vs WebSocket å¯¹æ¯”**:

| ç‰¹æ€§ | TCP | HTTP | WebSocket |
|------|-----|-----|-----------|
| **åè®®å±‚** | **ä¼ è¾“å±‚** | åº”ç”¨å±‚ | åº”ç”¨å±‚ |
| **é€šä¿¡æ¨¡å¼** | å…¨åŒå·¥ âœ… | åŠåŒå·¥ âŒ | å…¨åŒå·¥ âœ… |
| **æœåŠ¡å™¨ä¸»åŠ¨æ¨é€** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒï¼ˆHTTP/1.0ï¼‰<br/>âš ï¸ éœ€è¦è½®è¯¢/é•¿è½®è¯¢ï¼ˆHTTP/1.1ï¼‰ | âœ… åŸç”Ÿæ”¯æŒ |
| **æ•°æ®æ ¼å¼** | å­—èŠ‚æµï¼ˆæ— è¯­ä¹‰ï¼‰ | æ–‡æœ¬åè®® | äºŒè¿›åˆ¶å¸§ |
| **æµè§ˆå™¨æ”¯æŒ** | âŒ ä¸æ”¯æŒï¼ˆåº”ç”¨å±‚æ— æ³•ç›´æ¥è®¿é—®ï¼‰ | âœ… åŸç”Ÿæ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ |
| **é€‚ç”¨åœºæ™¯** | RPCã€è‡ªå®šä¹‰åè®® | REST API | **å®æ—¶æ¨é€** |

**ä¸ºä»€ä¹ˆ WebSocket é€‚åˆæœåŠ¡å™¨æ¨é€ï¼Ÿ**

```
ä¼ ç»Ÿ HTTP è½®è¯¢ï¼ˆä¸æ¨èï¼‰:
å®¢æˆ·ç«¯ â”€â”€â–¶ æœåŠ¡å™¨: æœ‰æ–°æ¶ˆæ¯å—ï¼Ÿ
   â”‚           æ²¡æœ‰
   â–¼
[ç­‰å¾…1ç§’]
   â”‚
å®¢æˆ·ç«¯ â”€â”€â–¶ æœåŠ¡å™¨: æœ‰æ–°æ¶ˆæ¯å—ï¼Ÿ
   â”‚           æ²¡æœ‰
   â–¼
[é‡å¤...]
é—®é¢˜: æµªè´¹èµ„æºã€å»¶è¿Ÿé«˜ã€æœåŠ¡å™¨å‹åŠ›å¤§ âŒ

WebSocket é•¿è¿æ¥ï¼ˆæ¨èï¼‰:
å®¢æˆ·ç«¯ â†â”€â”€â”€â”€â”€â”€ WebSocket è¿æ¥ â”€â”€â”€â”€â”€â”€â†’ æœåŠ¡å™¨
   â”‚                                        â”‚
è¿æ¥å»ºç«‹åï¼ŒæœåŠ¡å™¨å¯ä»¥éšæ—¶æ¨é€ âœ…          å®¢æˆ·ç«¯å¯ä»¥éšæ—¶å‘é€ âœ…
å®æ—¶æ€§å¥½ã€èµ„æºå ç”¨ä½ã€å»¶è¿Ÿå° âœ…
```

### 9.2 WebSocket å®ç°æ¶æ„

#### ä»£ç ç¤ºä¾‹ï¼ˆWebSocketServer.java ç¬¬66-83è¡Œï¼‰

```java
protected void initChannel(SocketChannel ch) {
    ChannelPipeline pipeline = ch.pipeline();

    // HTTPç¼–è§£ç å™¨
    pipeline.addLast(new HttpServerCodec());

    // HTTPæ¶ˆæ¯èšåˆå™¨ï¼ˆå°†å¤šä¸ªHttpRequest/HttpContentèšåˆä¸ºFullHttpRequestï¼‰
    pipeline.addLast(new HttpObjectAggregator(65536));

    // æ”¯æŒå¤§æ–‡ä»¶ä¼ è¾“
    pipeline.addLast(new ChunkedWriteHandler());

    // WebSocketåè®®å¤„ç†å™¨ï¼ˆå¤„ç†æ¡æ‰‹ã€å¸§å¤„ç†ç­‰ï¼‰â˜…æ ¸å¿ƒâ˜…
    pipeline.addLast(new WebSocketServerProtocolHandler(path));

    // è‡ªå®šä¹‰ä¸šåŠ¡å¤„ç†å™¨
    pipeline.addLast(new WebSocketServerHandler());
}
```

**Pipeline ç»“æ„**:

```mermaid
graph LR
    A[Head] --> B[HttpServerCodec<br/>HTTPç¼–è§£ç ]
    B --> C[HttpObjectAggregator<br/>HTTPæ¶ˆæ¯èšåˆ]
    C --> D[ChunkedWriteHandler<br/>å¤§æ–‡ä»¶ä¼ è¾“]
    D --> E[WebSocketServerProtocolHandler<br/>WebSocketåè®®å¤„ç†]
    E --> F[WebSocketServerHandler<br/>ä¸šåŠ¡é€»è¾‘]
    F --> G[Tail]

    style B fill:#99f,stroke:#333,stroke-width:2px
    style C fill:#99f,stroke:#333,stroke-width:2px
    style D fill:#fc9,stroke:#333,stroke-width:2px
    style E fill:#f96,stroke:#333,stroke-width:3px
    style F fill:#9f9,stroke:#333,stroke-width:2px
```

### 9.3 ä¸ºä»€ä¹ˆéœ€è¦ HTTP ç¼–è§£ç å™¨ï¼Ÿ

**æ ¸å¿ƒåŸå› **ï¼š**WebSocket æ˜¯åŸºäº HTTP å‡çº§è€Œæ¥çš„ï¼**

#### WebSocket æ¡æ‰‹æµç¨‹

```
é˜¶æ®µ1: HTTP æ¡æ‰‹è¯·æ±‚
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨:
    GET /ws HTTP/1.1
    Host: localhost:9002
    Upgrade: websocket          â† è¯·æ±‚å‡çº§åˆ° WebSocket
    Connection: Upgrade
    Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
    Sec-WebSocket-Version: 13

    â†“ HttpServerCodec è§£ç  HTTP è¯·æ±‚

é˜¶æ®µ2: HTTP æ¡æ‰‹å“åº”
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯:
    HTTP/1.1 101 Switching Protocols  â† åè®®åˆ‡æ¢æˆåŠŸ
    Upgrade: websocket
    Connection: Upgrade
    Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=

    â†“ è¿æ¥å‡çº§ä¸º WebSocketï¼Œåç»­ä½¿ç”¨ WebSocket å¸§é€šä¿¡

é˜¶æ®µ3: WebSocket å¸§é€šä¿¡
å®¢æˆ·ç«¯ â†â”€â”€â”€â”€â”€â”€ WebSocket å¸§ â”€â”€â”€â”€â”€â”€â†’ æœåŠ¡å™¨
    TextFrameã€BinaryFrameã€PingFrameã€PongFrameã€CloseFrame
```

**å…³é”®ç‚¹**:
1. âœ… **æ¡æ‰‹é˜¶æ®µä½¿ç”¨ HTTP åè®®**
2. âœ… **éœ€è¦ HttpServerCodec è§£ç  HTTP æ¡æ‰‹è¯·æ±‚**
3. âœ… **éœ€è¦ HttpObjectAggregator èšåˆå®Œæ•´çš„æ¡æ‰‹è¯·æ±‚**
4. âœ… **æ¡æ‰‹æˆåŠŸåï¼Œåè®®å‡çº§ä¸º WebSocket**

### 9.4 æ ¸å¿ƒå¤„ç†å™¨ï¼šWebSocketServerProtocolHandler

```java
pipeline.addLast(new WebSocketServerProtocolHandler(path));  // path = "/ws"
```

**èŒè´£**ï¼ˆè¿™æ˜¯ WebSocket æœåŠ¡å™¨çš„æ ¸å¿ƒï¼ï¼‰:

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **å¤„ç†æ¡æ‰‹** | éªŒè¯ `Sec-WebSocket-Key`ï¼Œè®¡ç®— `Sec-WebSocket-Accept`ï¼Œè¿”å› 101 å“åº” |
| **åè®®å‡çº§** | å°† HTTP è¿æ¥å‡çº§ä¸º WebSocket è¿æ¥ |
| **Ping/Pong å¤„ç†** | è‡ªåŠ¨å¤„ç†å¿ƒè·³å¸§ï¼ˆå¯é€‰ï¼‰ |
| **å¸§ç¼–è§£ç ** | è§£ç  WebSocket å¸§ï¼ˆText/Binary/Ping/Pong/Closeï¼‰ |
| **åˆ†ç‰‡å¤„ç†** | å¤„ç†å¤§æ¶ˆæ¯çš„åˆ†ç‰‡ä¼ è¾“ |
| **å…³é—­è¿æ¥** | å¤„ç† Close å¸§ï¼Œä¼˜é›…å…³é—­è¿æ¥ |

**ä¸ºä»€ä¹ˆå®ƒæ˜¯æ ¸å¿ƒï¼Ÿ**

```
æ²¡æœ‰ WebSocketServerProtocolHandler:
éœ€è¦æ‰‹åŠ¨å®ç°æ¡æ‰‹é€»è¾‘ âŒ
éœ€è¦æ‰‹åŠ¨è§£æ WebSocket å¸§æ ¼å¼ âŒ
éœ€è¦å¤„ç†åˆ†ç‰‡ã€æ©ç ç­‰å¤æ‚é€»è¾‘ âŒ

æœ‰ WebSocketServerProtocolHandler:
åªéœ€å¤„ç†ä¸šåŠ¡é€»è¾‘ âœ…
æ¡æ‰‹ã€å¸§è§£æå…¨éƒ¨è‡ªåŠ¨åŒ– âœ…
ç¬¦åˆæœ€ä½³å®è·µ âœ…
```

### 9.5 ä¸šåŠ¡ Handlerï¼šæ³›å‹ä¼˜åŒ–

#### ä»£ç ç¤ºä¾‹ï¼ˆWebSocketServerHandler.javaï¼‰

```java
public class WebSocketServerHandler extends SimpleChannelInboundHandler<WebSocketFrame> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, WebSocketFrame frame) {
        // å¤„ç†æ–‡æœ¬æ¶ˆæ¯
        if (frame instanceof TextWebSocketFrame) {
            String request = ((TextWebSocketFrame) frame).text();
            log.info("æ”¶åˆ°WebSocketæ¶ˆæ¯: {}", request);

            // æ„é€ å“åº”æ¶ˆæ¯
            String response = "æœåŠ¡å™¨å›å¤: " + request;
            ctx.channel().write(new TextWebSocketFrame(response));
            return;
        }

        // å¤„ç†Pingå¸§ï¼ˆå¿ƒè·³æ£€æµ‹ï¼‰
        if (frame instanceof PongWebSocketFrame) {
            ctx.write(new PongWebSocketFrame(frame.content().retain()));
            return;
        }

        // å¤„ç†å…³é—­è¿æ¥è¯·æ±‚
        if (frame instanceof CloseWebSocketFrame) {
            ctx.close();
            return;
        }

        // ä¸æ”¯æŒçš„å¸§ç±»å‹
        log.error("ä¸æ”¯æŒçš„WebSocketå¸§ç±»å‹: {}", frame.getClass().getName());
        ctx.close();
    }
}
```

#### æ³›å‹é€‰æ‹©

| æ–¹æ¡ˆ | æ³›å‹ | è¯´æ˜ |
|------|------|------|
| âŒ ä¸æ¨è | `<HttpObject>` | å¤ªæ¨¡ç³Šï¼Œéœ€è¦ç±»å‹åˆ¤æ–­ |
| âš ï¸ å¯ä»¥ç”¨ | `<WebSocketFrame>` | é€šç”¨ï¼Œä½†ä»éœ€ `instanceof` åˆ¤æ–­ |
| âœ… æ¨è | `<TextWebSocketFrame>` | åªå¤„ç†æ–‡æœ¬å¸§ï¼Œä»£ç æœ€ç®€æ´ |

**ä¼˜åŒ–å»ºè®®**ï¼ˆå¦‚æœåªå¤„ç†æ–‡æœ¬æ¶ˆæ¯ï¼‰:

```java
// æ¨èï¼šåªå¤„ç†æ–‡æœ¬å¸§
public class WebSocketServerHandler extends SimpleChannelInboundHandler<TextWebSocketFrame> {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame frame) {
        // âœ… ç›´æ¥å°±æ˜¯ TextWebSocketFrameï¼Œæ— éœ€ç±»å‹åˆ¤æ–­
        String request = frame.text();
        String response = "æœåŠ¡å™¨å›å¤: " + request;
        ctx.channel().writeAndFlush(new TextWebSocketFrame(response));
    }
}
```

### 9.6 WebSocket å¸§ç±»å‹

```java
WebSocketFrame (é¡¶å±‚æ¥å£)
    â”‚
    â”œâ”€â”€ TextWebSocketFrame      (æ–‡æœ¬å¸§) âœ… æœ€å¸¸ç”¨
    â”œâ”€â”€ BinaryWebSocketFrame    (äºŒè¿›åˆ¶å¸§)
    â”œâ”€â”€ PingWebSocketFrame       (å¿ƒè·³è¯·æ±‚å¸§)
    â”œâ”€â”€ PongWebSocketFrame       (å¿ƒè·³å“åº”å¸§)
    â””â”€â”€ CloseWebSocketFrame      (å…³é—­è¿æ¥å¸§)
```

**å®é™…ä¾‹å­**:

```java
// å®¢æˆ·ç«¯å‘é€æ–‡æœ¬æ¶ˆæ¯
TextWebSocketFrame textFrame = new TextWebSocketFrame("Hello Server");
ctx.channel().writeAndFlush(textFrame);

// æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ï¼ˆå…¨åŒå·¥ï¼‰
ctx.channel().writeAndFlush(new TextWebSocketFrame("å®æ—¶æ¶ˆæ¯ï¼šè‚¡ç¥¨ä»·æ ¼ä¸Šæ¶¨äº†ï¼"));

// å‘é€äºŒè¿›åˆ¶æ•°æ®
ByteBuf buf = Unpooled.copiedBuffer(new byte[]{0x01, 0x02, 0x03});
ctx.channel().writeAndFlush(new BinaryWebSocketFrame(buf));

// å…³é—­è¿æ¥
ctx.channel().writeAndFlush(new CloseWebSocketFrame(1000, "æ­£å¸¸å…³é—­"));
```

#### âš ï¸ å¯ä¼˜åŒ–çš„åœ°æ–¹

1. **æ³›å‹å¯ä»¥æ›´ç²¾ç¡®**
   
   ```java
   // å½“å‰ï¼šæ³›å‹æ˜¯ WebSocketFrame
   public class WebSocketServerHandler extends SimpleChannelInboundHandler<WebSocketFrame>
   
   // ä¼˜åŒ–ï¼šå¦‚æœåªå¤„ç†æ–‡æœ¬ï¼Œå¯ä»¥ç”¨ TextWebSocketFrame
   public class WebSocketServerHandler extends SimpleChannelInboundHandler<TextWebSocketFrame>
   ```
   
2. **è¿æ¥ç®¡ç†**
   ```java
   // å¯ä»¥æ·»åŠ è¿æ¥ç®¡ç†
   private static final ChannelGroup channels = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE);
   
   @Override
   public void channelActive(ChannelHandlerContext ctx) {
       channels.add(ctx.channel());  // è®°å½•æ‰€æœ‰è¿æ¥
       ctx.channel().writeAndFlush(new TextWebSocketFrame("æ¬¢è¿è¿æ¥ï¼"));
   }
   
   @Override
   public void channelInactive(ChannelHandlerContext ctx) {
       channels.remove(ctx.channel());  // ç§»é™¤æ–­å¼€çš„è¿æ¥
   }
   
   // å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯
   public void broadcast(String message) {
       channels.writeAndFlush(new TextWebSocketFrame(message));
   }
   ```

3. **å¿ƒè·³æ£€æµ‹**
   
   ```java
   // WebSocketServerProtocolHandler é…ç½®
   new WebSocketServerProtocolHandler(
       "/ws",              // WebSocket è·¯å¾„
       null,               // å­åè®®ï¼ˆå¯é€‰ï¼‰
       true,               // æ”¯æŒæ‰©å±•
       65536,              // æœ€å¤§å¸§å¤§å°
       false,              // å…è®¸æ‰©å±•
       true                // â˜… è‡ªåŠ¨å‘é€å¿ƒè·³ï¼ˆPingï¼‰
   )
   ```

### 9.7 ä¸‰ç§æœåŠ¡å™¨å®Œæ•´å¯¹æ¯”

#### åè®®å±‚æ¬¡

```mermaid
flowchart TB
    subgraph tcp ["ä¼ è¾“å±‚-TCP"]
        A1["TCPæœåŠ¡å™¨<br/>å­—èŠ‚æµ"]
    end

    subgraph http ["åº”ç”¨å±‚-HTTP"]
        B1["HTTPæœåŠ¡å™¨<br/>è¯·æ±‚-å“åº”æ¨¡å¼"]
        B2["WebSocketæœåŠ¡å™¨<br/>åŸºäºHTTPå‡çº§<br/>å…¨åŒå·¥å®æ—¶é€šä¿¡"]
    end

    %% ä¿®å¤è¿æ¥è¯­æ³•ï¼šä½¿ç”¨åŒå¼•å·åŒ…è£¹ä¸­æ–‡ï¼Œå¹¶ä¿®æ­£è™šçº¿ç»“å°¾
    A1 -. "æä¾›åŸºç¡€" .- B1
    A1 -. "æä¾›åŸºç¡€" .- B2

    style B2 fill:#9f9,stroke:#333,stroke-width:3px
```

#### è¯¦ç»†å¯¹æ¯”

| ç‰¹æ€§ | TCP æœåŠ¡å™¨ | HTTP æœåŠ¡å™¨ | WebSocket æœåŠ¡å™¨ |
|------|-----------|------------|-----------------|
| **åè®®å±‚** | ä¼ è¾“å±‚ | åº”ç”¨å±‚ | åº”ç”¨å±‚ï¼ˆåŸºäºHTTPå‡çº§ï¼‰ |
| **åº•å±‚ä¼ è¾“** | TCP | TCP | TCP |
| **æ•°æ®æ ¼å¼** | å­—èŠ‚æµ | HTTP æ–‡æœ¬åè®® | WebSocket äºŒè¿›åˆ¶å¸§ |
| **é€šä¿¡æ¨¡å¼** | å…¨åŒå·¥ | åŠåŒå·¥ï¼ˆè¯·æ±‚-å“åº”ï¼‰ | **å…¨åŒå·¥** âœ… |
| **æœåŠ¡å™¨æ¨é€** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… **åŸç”Ÿæ”¯æŒ** âœ… |
| **æµè§ˆå™¨æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ |
| **è¿æ¥æ¨¡å¼** | é•¿è¿æ¥ | çŸ­è¿æ¥/é•¿è¿æ¥ | **é•¿è¿æ¥** |
| **Pipeline å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ | **å¤æ‚**ï¼ˆéœ€è¦HTTP+WebSocketï¼‰ |
| **éœ€è¦ç¼–è§£ç å™¨** | âŒ ä¸éœ€è¦ | âœ… HTTP ç¼–è§£ç å™¨ | âœ… HTTP + WebSocket ç¼–è§£ç å™¨ |
| **æ ¸å¿ƒ Handler** | è‡ªå®šä¹‰ä¸šåŠ¡ Handler | HttpServerCodec<br/>HttpObjectAggregator | **WebSocketServerProtocolHandler** â­ |
| **æ³›å‹ç±»å‹** | ByteBuf | FullHttpRequest | WebSocketFrame / TextWebSocketFrame |
| **é€‚ç”¨åœºæ™¯** | RPCã€è‡ªå®šä¹‰åè®® | REST APIã€Web æœåŠ¡ | **å®æ—¶æ¨é€**ï¼ˆèŠå¤©ã€è‚¡ç¥¨ã€æ¸¸æˆï¼‰ |

#### Pipeline å¯¹æ¯”

```
TCP æœåŠ¡å™¨ï¼ˆæœ€ç®€å•ï¼‰:
Head â”€â”€â–¶ TcpServerHandler â”€â”€â–¶ Tail

HTTP æœåŠ¡å™¨ï¼ˆä¸­ç­‰ï¼‰:
Head â”€â”€â–¶ HttpServerCodec â”€â”€â–¶ HttpObjectAggregator â”€â”€â–¶ HttpServerHandler â”€â”€â–¶ Tail

WebSocket æœåŠ¡å™¨ï¼ˆå¤æ‚ï¼‰:
Head â”€â”€â–¶ HttpServerCodec â”€â”€â–¶ HttpObjectAggregator â”€â”€â–¶ ChunkedWriteHandler
        â”€â”€â–¶ WebSocketServerProtocolHandler â”€â”€â–¶ WebSocketServerHandler â”€â”€â–¶ Tail
         (HTTPæ¡æ‰‹)      (åè®®å‡çº§)              (ä¸šåŠ¡é€»è¾‘)
```

### 9.8 æ€»ç»“ï¼šä¸ºä»€ä¹ˆæ¨è WebSocketï¼Ÿ

1. âœ… **æµè§ˆå™¨åŸç”Ÿæ”¯æŒ**ï¼ˆTCP ä¸æ”¯æŒï¼‰
2. âœ… **å…¨åŒå·¥å®æ—¶é€šä¿¡**ï¼ˆHTTP ä¸æ”¯æŒä¸»åŠ¨æ¨é€ï¼‰
3. âœ… **ä½å»¶è¿Ÿã€ä½å¼€é”€**ï¼ˆç›¸æ¯” HTTP è½®è¯¢ï¼‰
4. âœ… **æ ‡å‡†åè®®**ï¼ˆç›¸æ¯”è‡ªå®šä¹‰ TCP åè®®ï¼‰
5. âœ… **Netty å¼€ç®±å³ç”¨**ï¼ˆWebSocketServerProtocolHandlerï¼‰

---

## åã€æ€»ç»“ä¸å…¶ä»–

### 10.1 æ ¸å¿ƒè¦ç‚¹

1. **Channel ç±»å‹é€‰æ‹©**: ä½¿ç”¨ `SocketChannel` æ¥å£ï¼Œè€Œä¸æ˜¯ `NioSocketChannel` å®ç°ç±»
2. **option() vs childOption()**:
   - `option()`: è®¾ç½®æœåŠ¡å™¨ Socket å‚æ•°ï¼ˆå¦‚ `SO_BACKLOG`ï¼‰
   - `childOption()`: è®¾ç½®å®¢æˆ·ç«¯è¿æ¥ Socket å‚æ•°ï¼ˆå¦‚ `SO_KEEPALIVE`ï¼‰
3. **ç¼–è§£ç å™¨**:
   - TCP æœåŠ¡å™¨ä¸éœ€è¦ç¼–è§£ç å™¨ï¼ˆå­—èŠ‚æµåè®®ï¼‰
   - HTTP æœåŠ¡å™¨éœ€è¦ç¼–è§£ç å™¨ï¼ˆåº”ç”¨å±‚æ–‡æœ¬åè®®ï¼‰
   - WebSocket æœåŠ¡å™¨éœ€è¦ HTTP + WebSocket ç¼–è§£ç å™¨
4. **HttpObjectAggregator**: å°†å¤šä¸ª HTTP æ¶ˆæ¯éƒ¨åˆ†èšåˆä¸ºå®Œæ•´çš„ `FullHttpRequest`
5. **æ³›å‹ä¼˜åŒ–**:
   - HTTP: ä½¿ç”¨ `FullHttpRequest` è€Œä¸æ˜¯ `HttpObject`
   - WebSocket: ä½¿ç”¨ `TextWebSocketFrame` è€Œä¸æ˜¯ `WebSocketFrame`ï¼ˆå¦‚æœåªå¤„ç†æ–‡æœ¬ï¼‰
6. **WebSocket æ ¸å¿ƒå¤„ç†å™¨**: `WebSocketServerProtocolHandler` æ˜¯ WebSocket æœåŠ¡å™¨çš„æ ¸å¿ƒï¼Œå¤„ç†æ¡æ‰‹ã€åè®®å‡çº§ã€å¸§ç¼–è§£ç 

### 10.2 ä¸‰ç§æœåŠ¡å™¨å®Œæ•´å¯¹æ¯”

| ç‰¹æ€§ | TCP æœåŠ¡å™¨ | HTTP æœåŠ¡å™¨ | WebSocket æœåŠ¡å™¨ |
|------|-----------|------------|-----------------|
| **åè®®å±‚** | ä¼ è¾“å±‚ | åº”ç”¨å±‚ | åº”ç”¨å±‚ï¼ˆåŸºäºHTTPå‡çº§ï¼‰ |
| **åº•å±‚ä¼ è¾“** | TCP | TCP | TCP |
| **æ•°æ®æ ¼å¼** | å­—èŠ‚æµ | HTTP æ–‡æœ¬åè®® | WebSocket äºŒè¿›åˆ¶å¸§ |
| **é€šä¿¡æ¨¡å¼** | å…¨åŒå·¥ | åŠåŒå·¥ï¼ˆè¯·æ±‚-å“åº”ï¼‰ | **å…¨åŒå·¥** âœ… |
| **æœåŠ¡å™¨æ¨é€** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… **åŸç”Ÿæ”¯æŒ** âœ… |
| **æµè§ˆå™¨æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ |
| **è¿æ¥æ¨¡å¼** | é•¿è¿æ¥ | çŸ­è¿æ¥/é•¿è¿æ¥ | **é•¿è¿æ¥** |
| **Pipeline å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ | **å¤æ‚**ï¼ˆéœ€è¦HTTP+WebSocketï¼‰ |
| **éœ€è¦ç¼–è§£ç å™¨** | âŒ ä¸éœ€è¦ | âœ… HTTP ç¼–è§£ç å™¨ | âœ… HTTP + WebSocket ç¼–è§£ç å™¨ |
| **æ ¸å¿ƒ Handler** | è‡ªå®šä¹‰ä¸šåŠ¡ Handler | HttpServerCodec<br/>HttpObjectAggregator | **WebSocketServerProtocolHandler** â­ |
| **æ³›å‹ç±»å‹** | ByteBuf | FullHttpRequest | WebSocketFrame / TextWebSocketFrame |
| **é€‚ç”¨åœºæ™¯** | RPCã€è‡ªå®šä¹‰åè®® | REST APIã€Web æœåŠ¡ | **å®æ—¶æ¨é€**ï¼ˆèŠå¤©ã€è‚¡ç¥¨ã€æ¸¸æˆï¼‰ |

### 10.3 Pipeline å¯¹æ¯”

```
TCP æœåŠ¡å™¨ï¼ˆæœ€ç®€å•ï¼‰:
Head â”€â”€â–¶ TcpServerHandler â”€â”€â–¶ Tail

HTTP æœåŠ¡å™¨ï¼ˆä¸­ç­‰ï¼‰:
Head â”€â”€â–¶ HttpServerCodec â”€â”€â–¶ HttpObjectAggregator â”€â”€â–¶ HttpServerHandler â”€â”€â–¶ Tail

WebSocket æœåŠ¡å™¨ï¼ˆå¤æ‚ï¼‰:
Head â”€â”€â–¶ HttpServerCodec â”€â”€â–¶ HttpObjectAggregator â”€â”€â–¶ ChunkedWriteHandler
        â”€â”€â–¶ WebSocketServerProtocolHandler â”€â”€â–¶ WebSocketServerHandler â”€â”€â–¶ Tail
         (HTTPæ¡æ‰‹)      (åè®®å‡çº§)              (ä¸šåŠ¡é€»è¾‘)
```

### 10.4 å…³é”®æŠ€æœ¯é€‰å‹

#### ä½•æ—¶ä½¿ç”¨å“ªç§æœåŠ¡å™¨ï¼Ÿ

```
éœ€æ±‚åˆ†æ:

1. éœ€è¦è‡ªå®šä¹‰åè®®ï¼ˆå¦‚ RPCï¼‰ï¼Ÿ
   â†“ Yes
   ä½¿ç”¨ TCP æœåŠ¡å™¨ âœ…

2. éœ€è¦æä¾› REST API æˆ– Web æœåŠ¡ï¼Ÿ
   â†“ Yes
   ä½¿ç”¨ HTTP æœåŠ¡å™¨ âœ…

3. éœ€è¦å®æ—¶æ¨é€ï¼ˆèŠå¤©ã€è‚¡ç¥¨ã€æ¸¸æˆï¼‰ï¼Ÿ
   â†“ Yes
   ä½¿ç”¨ WebSocket æœåŠ¡å™¨ âœ…
```

#### ç¼–è§£ç å™¨é€‰æ‹©æŒ‡å—

| åè®® | ç¼–è§£ç å™¨ | è¯´æ˜ |
|------|---------|------|
| **TCP** | æ—  | ç›´æ¥å¤„ç† ByteBuf |
| **HTTP** | HttpServerCodec + HttpObjectAggregator | è§£æ HTTP è¯·æ±‚ |
| **WebSocket** | HttpServerCodec + HttpObjectAggregator + WebSocketServerProtocolHandler | HTTP æ¡æ‰‹ + WebSocket å¸§ |

### 10.5 å­¦ä¹ å»ºè®®

1. **å…ˆæŒæ¡ TCP æœåŠ¡å™¨**
   - ç†è§£ Netty åŸºæœ¬æ¶æ„
   - ç†è§£ EventLoop å’Œ Pipeline
   - ç†è§£ ByteBuf çš„ä½¿ç”¨

2. **å†å­¦ä¹  HTTP æœåŠ¡å™¨**
   - ç†è§£ä¸ºä»€ä¹ˆéœ€è¦ç¼–è§£ç å™¨
   - ç†è§£ HttpObjectAggregator çš„ä½œç”¨
   - ç†è§£ FullHttpRequest çš„ç»“æ„

3. **æœ€åå­¦ä¹  WebSocket æœåŠ¡å™¨**
   - ç†è§£ WebSocket åŸºäº HTTP å‡çº§
   - ç†è§£ WebSocketServerProtocolHandler çš„æ ¸å¿ƒä½œç”¨
   - ç†è§£ä¸åŒå¸§ç±»å‹çš„å¤„ç†

4. **å®è·µå»ºè®®**
   - ä»ç®€å•åˆ°å¤æ‚ï¼šTCP â†’ HTTP â†’ WebSocket
   - æ¯ç§æœåŠ¡å™¨éƒ½è¦äº²æ‰‹å®ç°ä¸€é
   - å¯¹æ¯”ä¸‰ç§æœåŠ¡å™¨çš„å·®å¼‚å’Œè”ç³»

### 10.6 Handler é€‰æ‹©æŒ‡å—

#### å…¥ç«™å¤„ç†å™¨é€‰æ‹©

| éœ€æ±‚ | æ¨è Handler | åŸå›  |
|------|-------------|------|
| **å¤§éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘** | âœ… **SimpleChannelInboundHandler\<T\>** | è‡ªåŠ¨ç±»å‹è½¬æ¢ã€è‡ªåŠ¨èµ„æºé‡Šæ”¾ |
| **åªå¤„ç†ä¸€ç§æ¶ˆæ¯ç±»å‹** | âœ… **SimpleChannelInboundHandler\<T\>** | ç±»å‹è¿‡æ»¤ã€ä»£ç ç®€æ´ |
| **éœ€è¦å¤„ç†å¤šç§ç±»å‹** | âš ï¸ ChannelInboundHandlerAdapter | çµæ´»æ§åˆ¶ç±»å‹åˆ¤æ–­ |
| **éœ€è¦åœ¨ Pipeline ä¸­ä¼ é€’æ¶ˆæ¯** | âš ï¸ ChannelInboundHandlerAdapter | å¯ä»¥è°ƒç”¨ `fireChannelRead()` |
| **TCP å­—èŠ‚æµå¤„ç†** | âš ï¸ ChannelInboundHandlerAdapter | éœ€è¦ç²¾ç¡®æ§åˆ¶èµ„æºé‡Šæ”¾ |

#### å‡ºç«™å¤„ç†å™¨ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | æ˜¯å¦éœ€è¦ä¸“é—¨å‡ºç«™å¤„ç†å™¨ | è¯´æ˜ |
|------|---------------------|------|
| **HTTP æœåŠ¡å™¨** | âŒ ä¸éœ€è¦ | `HttpServerCodec` å·²åŒ…å«ç¼–ç å™¨ |
| **WebSocket æœåŠ¡å™¨** | âŒ ä¸éœ€è¦ | `WebSocketServerProtocolHandler` å·²åŒ…å«å¸§ç¼–ç å™¨ |
| **è‡ªå®šä¹‰åè®®ï¼ˆéœ€è¦ç¼–ç ï¼‰** | âœ… éœ€è¦ | æ·»åŠ  `MessageToByteEncoder` |
| **éœ€è¦å‹ç¼©æ•°æ®** | âš ï¸ å¯é€‰ | æ·»åŠ å‹ç¼©å‡ºç«™å¤„ç†å™¨ |
| **éœ€è¦åŠ å¯†æ•°æ®** | âš ï¸ å¯é€‰ | æ·»åŠ åŠ å¯†å‡ºç«™å¤„ç†å™¨ |
| **è®°å½•å‘é€æ—¥å¿—** | âš ï¸ å¯é€‰ | æ·»åŠ æ—¥å¿—å‡ºç«™å¤„ç†å™¨ |

**æ ¸å¿ƒåŸåˆ™**: âœ… **ä¼˜å…ˆä½¿ç”¨ Netty è‡ªå¸¦çš„ Handler**ï¼Œå¿…è¦æ—¶å†è‡ªå®šä¹‰

---

**ä½œè€…**: clazs
**æ—¥æœŸ**: 2026-01-22
**åŸºäº**: springboot-netty é¡¹ç›®ä»£ç å®ç°
