<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-item {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .status-item .label {
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .status-item .value {
            color: #667eea;
            font-size: 32px;
            font-weight: bold;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            outline: none;
            transition: border-color 0.3s;
        }

        textarea:focus {
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .log-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-item {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid transparent;
        }

        .log-item.info {
            border-left-color: #2196f3;
        }

        .log-item.success {
            border-left-color: #4caf50;
        }

        .log-item.error {
            border-left-color: #f44336;
        }

        .log-time {
            color: #888;
            margin-right: 10px;
        }

        .quick-messages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-btn {
            padding: 10px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .quick-btn:hover {
            border-color: #667eea;
            background: #e8eaf6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ WebSocket æœåŠ¡ç«¯ç®¡ç†åå°</h1>
            <p>å‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ä¸»åŠ¨æ¨é€æ¶ˆæ¯</p>
        </div>

        <div class="card">
            <h2>ğŸ“Š è¿æ¥çŠ¶æ€</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="label">å½“å‰è¿æ¥æ•°</div>
                    <div class="value" id="connectionCount">0</div>
                </div>
                <div class="status-item">
                    <div class="label">æœåŠ¡çŠ¶æ€</div>
                    <div class="value" id="serverStatus" style="font-size: 20px; color: #4caf50;">è¿è¡Œä¸­</div>
                </div>
                <div class="status-item">
                    <div class="label">æ¨é€æ¶ˆæ¯æ•°</div>
                    <div class="value" id="messageCount">0</div>
                </div>
                <div class="status-item">
                    <div class="label">æœåŠ¡ç«¯å£</div>
                    <div class="value" style="font-size: 20px;">9058</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“¤ æ¨é€æ¶ˆæ¯</h2>

            <div class="quick-messages">
                <div class="quick-btn" onclick="setQuickMessage('ç³»ç»Ÿé€šçŸ¥ï¼šæœåŠ¡å™¨å°†åœ¨5åˆ†é’Ÿåè¿›è¡Œç»´æŠ¤')">ç³»ç»Ÿç»´æŠ¤é€šçŸ¥</div>
                <div class="quick-btn" onclick="setQuickMessage('æ­å–œï¼æ‚¨è·å¾—äº†ä¸€ä¸ªæ–°æˆå°±')">æˆå°±è§£é”</div>
                <div class="quick-btn" onclick="setQuickMessage('æ‚¨æœ‰æ–°çš„è®¢å•ï¼Œè¯·åŠæ—¶å¤„ç†')">æ–°è®¢å•æé†’</div>
                <div class="quick-btn" onclick="setQuickMessage('æ¬¢è¿ä½¿ç”¨WebSocketå®æ—¶é€šä¿¡ç³»ç»Ÿï¼')">æ¬¢è¿æ¶ˆæ¯</div>
            </div>

            <div class="input-group">
                <label>æ¶ˆæ¯å†…å®¹ï¼š</label>
                <textarea id="messageContent" placeholder="è¯·è¾“å…¥è¦æ¨é€çš„æ¶ˆæ¯å†…å®¹..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="broadcastMessage()">ğŸ“¡ å¹¿æ’­æ¶ˆæ¯</button>
                <button class="btn-success" onclick="sendSystemNotification()">ğŸ”” å‘é€ç³»ç»Ÿé€šçŸ¥</button>
                <button class="btn-warning" onclick="sendWelcome()">ğŸ‘‹ å‘é€æ¬¢è¿æ¶ˆæ¯</button>
                <button class="btn-danger" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
            <div class="log-area" id="logArea">
                <div class="log-item info">
                    <span class="log-time">[ç³»ç»Ÿ]</span>
                    ç®¡ç†åå°å·²å¯åŠ¨ï¼Œç­‰å¾…æ“ä½œ...
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:9058/api/ws';
        let messageCount = 0;

        // è®¾ç½®å¿«æ·æ¶ˆæ¯
        function setQuickMessage(message) {
            document.getElementById('messageContent').value = message;
            addLog('å·²é€‰æ‹©å¿«æ·æ¶ˆæ¯: ' + message, 'info');
        }

        // è·å–è¿æ¥æ•°
        async function fetchConnectionCount() {
            try {
                const response = await fetch(`${API_BASE_URL}/connections`);
                const data = await response.json();
                document.getElementById('connectionCount').textContent = data.connectionCount;
                return data.connectionCount;
            } catch (error) {
                console.error('è·å–è¿æ¥æ•°å¤±è´¥:', error);
                return 0;
            }
        }

        // å¹¿æ’­æ¶ˆæ¯
        async function broadcastMessage() {
            const content = document.getElementById('messageContent').value.trim();
            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼');
                return;
            }

            try {
                addLog('æ­£åœ¨æ¨é€å¹¿æ’­æ¶ˆæ¯...', 'info');

                const response = await fetch(`${API_BASE_URL}/broadcast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: content })
                });

                const data = await response.json();

                if (data.success) {
                    addLog(`âœ… å¹¿æ’­æ¶ˆæ¯æˆåŠŸ: ${content}`, 'success');
                    addLog(`å½“å‰è¿æ¥æ•°: ${data.connectionCount}`, 'info');
                    messageCount++;
                    document.getElementById('messageCount').textContent = messageCount;
                    document.getElementById('messageContent').value = '';
                    await fetchConnectionCount();
                } else {
                    addLog(`âŒ æ¨é€å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ æ¨é€å¤±è´¥: ${error.message}`, 'error');
                console.error('æ¨é€æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // å‘é€ç³»ç»Ÿé€šçŸ¥
        async function sendSystemNotification() {
            const notification = `ã€ç³»ç»Ÿé€šçŸ¥ã€‘${new Date().toLocaleString()} - ç³»ç»Ÿè¿è¡Œæ­£å¸¸`;

            try {
                addLog('æ­£åœ¨å‘é€ç³»ç»Ÿé€šçŸ¥...', 'info');

                const response = await fetch(`${API_BASE_URL}/notify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'ç³»ç»ŸçŠ¶æ€',
                        content: 'ç³»ç»Ÿè¿è¡Œæ­£å¸¸'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addLog(`âœ… ç³»ç»Ÿé€šçŸ¥å·²å‘é€`, 'success');
                    messageCount++;
                    document.getElementById('messageCount').textContent = messageCount;
                } else {
                    addLog(`âŒ å‘é€å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
                console.error('å‘é€ç³»ç»Ÿé€šçŸ¥å¤±è´¥:', error);
            }
        }

        // å‘é€æ¬¢è¿æ¶ˆæ¯
        async function sendWelcome() {
            const connectionCount = await fetchConnectionCount();
            const welcome = `ğŸ‰ æ¬¢è¿æ–°ç”¨æˆ·åŠ å…¥ï¼å½“å‰åœ¨çº¿äººæ•°ï¼š${connectionCount}`;

            try {
                addLog('æ­£åœ¨å‘é€æ¬¢è¿æ¶ˆæ¯...', 'info');

                const response = await fetch(`${API_BASE_URL}/broadcast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: welcome })
                });

                const data = await response.json();

                if (data.success) {
                    addLog(`âœ… æ¬¢è¿æ¶ˆæ¯å·²å‘é€`, 'success');
                    messageCount++;
                    document.getElementById('messageCount').textContent = messageCount;
                } else {
                    addLog(`âŒ å‘é€å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
                console.error('å‘é€æ¬¢è¿æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const now = new Date();
            const time = now.getHours().toString().padStart(2, '0') + ':' +
                        now.getMinutes().toString().padStart(2, '0') + ':' +
                        now.getSeconds().toString().padStart(2, '0');

            const logItem = document.createElement('div');
            logItem.className = 'log-item ' + type;
            logItem.innerHTML = `<span class="log-time">[${time}]</span>${message}`;

            logArea.appendChild(logItem);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            addLog('ç®¡ç†åå°å·²å¯åŠ¨ï¼Œæ­£åœ¨è¿æ¥æœåŠ¡å™¨...', 'info');

            // ç«‹å³è·å–ä¸€æ¬¡è¿æ¥æ•°
            fetchConnectionCount();

            // æ¯5ç§’æ›´æ–°ä¸€æ¬¡è¿æ¥æ•°
            setInterval(fetchConnectionCount, 5000);

            addLog('ç®¡ç†åå°åˆå§‹åŒ–å®Œæˆ', 'success');
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                broadcastMessage();
            }
        });
    </script>
</body>
</html>
